--[[⠀
----------------------------------------------------------------------------------------------------------------------------⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀                       ⠀⢀⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣀⣀⣀⣀⣀⣀⣀⣰⣦⣀⣀⠀⠠⠄⠄⠠⠀⠀⢀⣠⣤⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣾⡏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣠⣶⡿⢿⣦⠀⠀⠀⠀⠀⠀⠀⢀⡷⠀⠀⠀⠀⠀⣀⠀⠀⠀⠀⠀⣩⡿⠋⠙⠉⢩⡿⠟⠀⠀⠀⠀⠀⠀⢀⣶⣾⠟⠋⠛⣿⣷⡄⠀⠀⠀⠀⠀⣴⣿⠂⠀⠀⣼⡿⠀⠀⠀⠀⠀⠀⢀⣠⡴⠶⣤⠀⠀⠀⠀⠀⠀⠀⠀⣠⣴⠦⠤⣤⣤⣀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⢀⣼⡿⠋⠀⢸⠏⠀⠀⠀⠀⠀⠀⠀⣼⠃⠀⠀⠀⠀⢠⡇⠀⠀⠀⢠⣾⠋⠀⠀⠀⠀⣸⠀⠀⠀⠀⠀⠀⠀⢠⣿⠋⠀⠀⠀⠀⠛⠛⠁⠀⠀⠀⢀⣾⣿⠏⠀⠀⢀⡿⠃⠀⠀⠀⠀⠀⠶⠋⠁⢀⣰⠟⠀⠀⠀⠀⠀⠀⠀⣹⣿⠀⠀⠀⠀⣨⣿⠇⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⣾⡟⢀⣠⣤⣴⣶⠆⠀⠀⠀⠀⠀⢰⠃⠀⠀⠀⠀⠀⣾⠀⠀⠀⣰⣿⠃⠀⠀⠀⠀⠀⣿⡀⠀⠀⠀⠀⠀⢀⣿⠃⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣸⣿⠋⠀⠀⢀⡾⠁⠀⠀⠀⠀⠀⠀⠀⣠⣶⣯⣅⡀⠀⠀⠀⠀⠀⠀⠀⣿⡇⢀⣠⠴⠞⠋⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⣸⡟⠀⠛⠉⣠⣾⠃⠀⠀⠀⠀⠀⠀⣼⠀⠀⠀⠀⠀⠀⢿⣤⡴⢺⢻⠃⠀⠀⠀⠀⠀⢸⡿⠁⠀⠀⠀⠀⠀⠀⢿⠀⠀⠀⠀⢀⣤⠀⠀⠀⠀⠀⢀⣿⣇⡤⠤⢤⣾⣤⣄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠙⢻⡆⠀⠀⠀⠀⠀⣿⣯⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⣿⠃⠀⠀⢀⣼⠇⠀⠀⠀⠀⠀⠀⣰⠏⠀⠀⠀⠀⠀⠀⠀⠀⠀⢂⠇⠀⠀⠀⠀⠀⠀⣾⡅⠀⠀⠀⠀⠀⠀⠀⢸⣧⡀⠀⠀⣼⠇⠀⠀⠀⠀⠀⢸⣿⠀⠀⠀⠐⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣼⠃⠀⠀⠀⠀⠀⢰⡏⠘⣦⠀⠀⠀⠀⡀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠘⢧⣤⡶⠟⢻⠀⠀⠀⠀⠀⠀⢠⡏⠀⠀⠀⠀⠀⠀⠀⠀⠀⢘⠏⠀⠀⠀⠀⠀⠀⢰⣿⡄⠀⠀⠀⠀⠀⠀⠀⠀⠙⠿⣶⡾⠋⠀⠀⠀⠀⠀⠀⢸⡟⠀⠀⠀⢰⠇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣀⠞⠁⠀⠀⠀⠀⠀⠀⠁⠀⠈⠙⠂⠔⠊⠁⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣼⠀⠀⠀⠀⠀⢀⣿⣤⠶⠒⠒⠁⠀⠀⠀⠀⢠⠏⠀⠀⠀⠀⠀⠀⠀⠀⠈⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠉⠀⠀⠀⠀⢸⠀⠀⠀⠀⠀⠀⠀⠀⠀⠄⠐⠊⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠃⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⡿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀

----------------------------------------------------------------------------------------------------------------------------
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
Please contact me if you need to hire someone to do mods or other design related tasks
https://steamcommunity.com/id/glytch3r/myworkshopfiles/
https://www.glytch3r.com
https://ko-fi.com/glytch3r
Discord: Glytch3r#2892

Special thanks to dhert for helping me with the animation xml and action
----------------------------------------------------------------------------------------------------------------------------
--]]

require "recipecode"
require "TimedActions/ISBaseTimedAction"

Recipe = Recipe or {}
Recipe.GetItemTypes = Recipe.GetItemTypes or {}
Recipe.OnCanPerform = Recipe.OnCanPerform or {}
Recipe.OnCreate = Recipe.OnCreate or {}
Recipe.OnGiveXP = Recipe.OnGiveXP or {}
Recipe.OnTest = Recipe.OnTest or {}
--
function isCannibal()
	if getPlayer():isAccessLevel('admin') then
		return true
	else
		return false
	end
end

local function isSomthingThere(square) 
    local pl = getPlayer() 
    --local square = -sq --pl:getSquare():getAdjacentSquare(pl:getDir())
    
	if not square then return false end
	
    --if square:isSomethingTo(pl:getSquare()) then return false end
	if pl:getCurrentSquare():isBlockedTo(square) then return false end
	if square:isSolid() or square:isSolidTrans() then return false end
	if square:HasStairs() then return false end
	if square:HasTree() then return false end
	if not square:getMovingObjects():isEmpty() then return false end
	if not square:TreatAsSolidFloor() then return false end
	--if not self:haveMaterial(square) then return false end
	for i=1,square:getObjects():size() do
		local obj = square:getObjects():get(i-1)
		if obj:getSprite() == obj:getTextureName() then return false end
    end
    if buildUtil.stairIsBlockingPlacement( square, true ) then return false; end
	if square:isVehicleIntersecting() then return false end
	return true
end


function TakeZedMeat()


end

function cannibalAct(pl, dest, body)
	pl:getStats():setHunger(pl:getStats():getHunger()-5)
    
	addBloodSplat(pl:getSquare(), 12);
	if dest == pl:getCurrentSquare() and isSomthingThere(dest)  then

			pl:getBodyDamage():RestoreToFullHealth()
			pl:getZombieKills()

	end
end

Events.OnFillWorldObjectContextMenu.Remove(CannibalContext);
local function CannibalContext(player, context, worldobjects, test)
	if isCannibal() == true then
		local x = getMouseX()
		local y = getMouseY()

		local body = IsoObjectPicker.Instance:PickCorpse(x, y)
		if not body then return end

		--local pl = getSpecificPlayer(player)
		--local playerInv = playerObj:getInventory()

		if test then return ISWorldObjectContextMenu.setTest() end

		--if isCannibalEquip() then
			local option = context:addDebugOption("Cannibal", worldobjects, nil);
			local subMenu = ISContextMenu:getNew(context);
			context:addSubMenu(option, subMenu);

			subMenu:addOption("Devour", body, (function()
				local pl = getSpecificPlayer(player)
				local dest = body:getSquare()
				local anim = 'Cannibal'
				--local adj = AdjacentFreeTileFinder.Find(dest, pl);
				--print("is player: "..body:isReanimatedPlayer())
				--ISWorldObjectContextMenu.equip(pl, handItem, ITEM, true, false)
				ISTimedActionQueue.add(ISWalkToTimedAction:new(pl, dest))
				--if ZombRand(1,3) == 1 then anim = 'Cannibal2' end
				ISTimedActionQueue.add(ISUndead:new(pl, dest, body))
				--ISTimedActionQueue.add(ISUndead:new(getSpecificPlayer(0), nil, adj))
			end))

			if #subMenu.options == 0 then
				context:removeLastOption()
			end
		--end
	end
end

Events.OnFillWorldObjectContextMenu.Add(NukaCannibalContext);



ISUndead = ISBaseTimedAction:derive("ISUndead");

function ISUndead:isValid()
	--if self.character:HasTrait("Cannibal") == true and isCannibalEquip() == true then
	if self.character:isAccessLevel('admin')  then
    return true
    else 
    return false
    end
end

function ISUndead:waitToStart()
    --self.character:faceThisObject(self.adj)

    return self.character:shouldBeTurning()
end

--[[ function ISUndead:update()
	self.character:faceThisObject(self.adj)
end ]]
function ISUndead:perform()
    -- needed to remove from queue / start next.
   -- addBloodSplat(self.character:getSquare(), 12);dw
	
	self.character:getStats():setHunger(self.character:getStats():getHunger()-5)
	self.character:getBodyDamage():RestoreToFullHealth()
	addBloodSplat(self.character:getSquare(), 12);

	self.character:getZombieKills()


    ISBaseTimedAction.perform(self)
end

function ISUndead:start()
	--self.character:faceThisObject(self.adj)
    self:setActionAnim('Cannibal')
end

function ISUndead:stop()
 --addBloodSplat(self.character:getSquare(), 12);
    ISBaseTimedAction.stop(self);
end

--isReanimatedPlayer() 
function ISUndead:new(character, dest, body)
    local o = ISBaseTimedAction.new(self, character)
	o.character = character
	--o.anim = anim
	o.dest = dest
	o.body = body
    o.stopOnWalk = true
    o.stopOnRun = true
    o.stopOnAim = true
    o.maxTime = 1--SandboxVars.Nuka.cannibalDuration
    if o.character:isTimedActionInstant() then o.maxTime = 1; end
	--o.knife = knife
    return o
end



